<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>EngliChat - Users</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            background: linear-gradient(
                to top right,
                #4EB5A9 0%,        
                #0a001a 30%,       
                #0a001a 70%,      
                #6157E1 100%       
            ); 
            color: white;
        }
        .btn {
            background: #7928ca;
        }
        .status-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .online {
            background-color: #28a745;
        }
        .offline {
            background-color: #6c757d;
        }
        /* Toast container */
        #toastContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
        }
    </style>
</head>
<body class="container mt-4">

    <h2 class="mb-4">Available Users</h2>

    <div class="row" th:if="${users.size() > 0}">
        <div class="col-md-4 mb-3" th:each="u : ${users}">
            <div class="card shadow-sm">

                <img th:if="${u.profileImage != null}" 
                     th:src="@{'/uploads/' + ${u.profileImage}}" 
                     class="card-img-top" 
                     alt="Profile Image" 
                     style="height:200px; object-fit:cover;">
                <img th:if="${u.profileImage == null}" 
                     src="/images/default-profile.png" 
                     class="card-img-top" 
                     alt="Default Profile Image" 
                     style="height:200px; object-fit:cover;">

                <div class="card-body text-center">
                    <h5 class="card-title">
                        <span th:classappend="${activeUsers.contains(u.username)} ? 'status-dot online' : 'status-dot offline'"></span>
                        <span th:text="${u.username}"></span>
                    </h5>
                    <a th:href="@{'/chat/' + ${u.username}}" class="btn">Chat with Co-learner</a>
                </div>
            </div>
        </div>
    </div>

    <div th:if="${users.size() == 0}">
        <div class="alert alert-info">No other users found.</div>
    </div>

    <!-- âœ… Toast Notification -->
    <div id="toastContainer">
      <div id="msgToast" class="toast align-items-center text-bg-primary border-0" role="alert">
        <div class="d-flex">
          <div class="toast-body" id="msgToastBody">New message</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    </div>

    <!-- Hidden input for current username -->
    <input type="hidden" id="me" th:value="${#authentication.name}" />

    <script>
      let stompClient = null;
      let toastEl = document.getElementById('msgToast');
      let toast = new bootstrap.Toast(toastEl);

      function connectWs() {
        const socket = new SockJS('/chat-websocket');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log("âœ… Connected Users WS: " + frame);

            stompClient.subscribe('/user/queue/messages', function (msg) {
                let message = JSON.parse(msg.body);
                const me = document.getElementById('me').value;

                if (message.sender !== me) {
                  // ðŸ‘‰ If already on chat page with this sender, skip
                  const peerInput = document.getElementById('peer');
                  if (peerInput && peerInput.value === message.sender) {
                    return; 
                  }

                  // Otherwise show toast
                  document.getElementById('msgToastBody').textContent =
                    "ðŸ“© " + message.sender + ": " + message.content;
                  toast.show();
                }
            });
        });
      }

      connectWs();
    </script>
</body>
</html>
